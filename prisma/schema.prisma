generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum ExperienceLevel {
  BEGINNER
  ADVANCED
  EXPERT
}

enum UseCaseType {
  PERSONAL
  BUSINESS
  AGENCY
}

enum DesignStatus {
  DRAFT
  GENERATED
  PUBLISHED
  ARCHIVED
  FAILED
}

enum GenerationStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELED
}

enum MockupStatus {
  DRAFT
  READY
  EXPORTED
}

enum TemplateStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  MODERATION_HOLD
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum OrderStatus {
  PENDING
  PAID
  FULFILLMENT
  IN_PRODUCTION
  SHIPPED
  DELIVERED
  CANCELED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PlanTier {
  FREE
  PRO
  BUSINESS
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  UNPAID
}

enum CreditUsageType {
  GENERATION
  UPSCALE
  REMOVE_BACKGROUND
  MOCKUP_EXPORT
  TEMPLATE_PURCHASE
  ADMIN_ADJUSTMENT
  BONUS
  OTHER
}

enum AffiliateStatus {
  INVITED
  SIGNED_UP
  CONVERTED
  CANCELED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  CANCELED
}

enum PayoutProvider {
  STRIPE
  PAYPAL
  MANUAL
}

enum AiProvider {
  OPENAI
  REPLICATE
  STABILITY
  LOCAL_SD
}

enum PodProvider {
  NONE
  PRINTFUL
  PRINTIFY
}

enum GarmentType {
  T_SHIRT
  HOODIE
  SWEATSHIRT
  SWEATER
  TANK_TOP
  HAT
  CAP
  MUG
  POSTER
  CANVAS
  STICKER
  TOTE_BAG
  PHONE_CASE
  NOTEBOOK
}

enum ReviewTargetType {
  STORE_PRODUCT
  TEMPLATE
}

model Storefront {
  id             String    @id @default(cuid())
  userId         String    @unique
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeName      String
  slug           String    @unique
  bio            String?
  bannerUrl      String?
  logoUrl        String?
  primaryColor   String    @default("#895af6")
  secondaryColor String?
  socialLinks    Json?
  customDomain   String?
  isPublished    Boolean   @default(false)
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([slug])
  @@index([isPublished])
}

model StorefrontFollow {
  id         String   @id @default(cuid())
  followerId String
  creatorId  String
  follower   User     @relation("StorefrontFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  creator    User     @relation("StorefrontFollowers", fields: [creatorId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([followerId, creatorId])
  @@index([creatorId, createdAt(sort: Desc)])
  @@index([followerId, createdAt(sort: Desc)])
}

model User {
  id                      String              @id @default(cuid())
  supabaseId              String              @unique
  email                   String              @unique
  passwordHash            String?
  username                String              @unique
  fullName                String?
  avatarUrl               String?
  bio                     String?
  role                    UserRole            @default(USER)
  useCase                 UseCaseType?
  experienceLevel         ExperienceLevel?
  onboardingCompleted     Boolean             @default(false)
  referralCode            String              @unique
  referredById            String?
  referredBy              User?               @relation("UserReferrals", fields: [referredById], references: [id], onDelete: SetNull)
  referrals               User[]              @relation("UserReferrals")
  designs                 Design[]
  generations             Generation[]
  mockups                 Mockup[]
  templates               Template[]          @relation("TemplateCreator")
  templatePurchases       TemplatePurchase[]  @relation("TemplateBuyer")
  storeProducts           StoreProduct[]      @relation("StoreProductOwner")
  ordersPlaced            Order[]             @relation("OrderBuyer")
  ordersReceived          Order[]             @relation("OrderSeller")
  subscriptions           Subscription[]
  creditUsages            CreditUsage[]
  affiliateReferralsSent  AffiliateReferral[] @relation("AffiliateReferrer")
  affiliateReferralSource AffiliateReferral?  @relation("AffiliateReferredUser")
  payouts                 Payout[]
  brandKits               BrandKit[]
  authoredReviews         Review[]            @relation("ReviewAuthor")
  receivedReviews         Review[]            @relation("ReviewSeller")
  followers               StorefrontFollow[]  @relation("StorefrontFollowers")
  following               StorefrontFollow[]  @relation("StorefrontFollowing")
  storefront              Storefront?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  lastLoginAt             DateTime?

  @@index([referredById])
  @@index([createdAt(sort: Desc)])
}

model Design {
  id                String         @id @default(cuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  title             String
  prompt            String
  negativePrompt    String?
  stylePreset       String?
  colorPalette      Json?
  referenceImageUrl String?
  primaryImageUrl   String?
  thumbnailUrl      String?
  metadata          Json?
  status            DesignStatus   @default(DRAFT)
  version           Int            @default(1)
  isPublic          Boolean        @default(false)
  generations       Generation[]
  mockups           Mockup[]
  storeProducts     StoreProduct[]
  templates         Template[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
}

model Generation {
  id                String           @id @default(cuid())
  userId            String
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  designId          String?
  design            Design?          @relation(fields: [designId], references: [id], onDelete: SetNull)
  provider          AiProvider
  model             String?
  prompt            String
  negativePrompt    String?
  referenceImageUrl String?
  colorPalette      Json?
  variationCount    Int              @default(1)
  status            GenerationStatus @default(QUEUED)
  progress          Int              @default(0)
  outputUrls        Json?
  errorMessage      String?
  costCredits       Int              @default(1)
  metadata          Json?
  creditUsages      CreditUsage[]
  createdAt         DateTime         @default(now())
  completedAt       DateTime?

  @@index([userId, createdAt(sort: Desc)])
  @@index([designId])
  @@index([status])
}

model Mockup {
  id            String         @id @default(cuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  designId      String?
  design        Design?        @relation(fields: [designId], references: [id], onDelete: SetNull)
  name          String
  garmentType   GarmentType    @default(T_SHIRT)
  garmentColor  String?
  canvasState   Json
  previewUrl    String?
  printReadyUrl String?
  dpi           Int            @default(300)
  status        MockupStatus   @default(DRAFT)
  metadata      Json?
  storeProducts StoreProduct[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([userId, createdAt(sort: Desc)])
  @@index([designId])
}

model Template {
  id             String             @id @default(cuid())
  creatorId      String
  creator        User               @relation("TemplateCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  designId       String?
  design         Design?            @relation(fields: [designId], references: [id], onDelete: SetNull)
  title          String
  description    String?
  tags           Json?
  thumbnailUrl   String?
  fileUrl        String?
  previewImages  Json?
  priceCents     Int
  currency       String             @default("USD")
  status         TemplateStatus     @default(DRAFT)
  isFeatured     Boolean            @default(false)
  downloadsCount Int                @default(0)
  metadata       Json?
  purchases      TemplatePurchase[]
  reviews        Review[]           @relation("ReviewTemplate")
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@index([creatorId, status])
  @@index([priceCents])
}

model TemplatePurchase {
  id                    String   @id @default(cuid())
  templateId            String
  template              Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  buyerId               String
  buyer                 User     @relation("TemplateBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  orderId               String?  @unique
  order                 Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  amountCents           Int
  currency              String   @default("USD")
  stripePaymentIntentId String?
  downloadUrl           String?
  metadata              Json?
  purchasedAt           DateTime @default(now())

  @@unique([templateId, buyerId])
  @@index([buyerId, purchasedAt(sort: Desc)])
}

model StoreProduct {
  id                String        @id @default(cuid())
  ownerId           String
  owner             User          @relation("StoreProductOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  designId          String?
  design            Design?       @relation(fields: [designId], references: [id], onDelete: SetNull)
  mockupId          String?
  mockup            Mockup?       @relation(fields: [mockupId], references: [id], onDelete: SetNull)
  slug              String
  title             String
  description       String?
  priceCents        Int
  currency          String        @default("USD")
  status            ProductStatus @default(DRAFT)
  podProvider       PodProvider   @default(NONE)
  providerProductId String?
  providerVariantId String?
  images            Json?
  printCostCents    Int?
  shippingProfile   Json?
  isFeatured        Boolean       @default(false)
  metadata          Json?
  orders            Order[]
  reviews           Review[]      @relation("ReviewStoreProduct")
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@unique([ownerId, slug])
  @@index([ownerId, status])
  @@index([podProvider])
}

model Order {
  id                      String            @id @default(cuid())
  buyerId                 String?
  buyer                   User?             @relation("OrderBuyer", fields: [buyerId], references: [id], onDelete: SetNull)
  sellerId                String
  seller                  User              @relation("OrderSeller", fields: [sellerId], references: [id], onDelete: Restrict)
  storeProductId          String?
  storeProduct            StoreProduct?     @relation(fields: [storeProductId], references: [id], onDelete: SetNull)
  templatePurchase        TemplatePurchase?
  status                  OrderStatus       @default(PENDING)
  paymentStatus           PaymentStatus     @default(PENDING)
  fulfillmentProvider     PodProvider       @default(NONE)
  fulfillmentOrderId      String?
  stripeCheckoutSessionId String?
  stripePaymentIntentId   String?
  amountSubtotalCents     Int
  amountTaxCents          Int               @default(0)
  amountTotalCents        Int
  currency                String            @default("USD")
  shippingAddress         Json?
  billingAddress          Json?
  metadata                Json?
  review                  Review?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt

  @@index([sellerId, createdAt(sort: Desc)])
  @@index([buyerId, createdAt(sort: Desc)])
  @@index([status])
}

model Subscription {
  id                     String             @id @default(cuid())
  userId                 String
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                   PlanTier           @default(FREE)
  status                 SubscriptionStatus @default(INCOMPLETE)
  providerCustomerId     String?
  providerSubscriptionId String?            @unique
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  trialEndsAt            DateTime?
  cancelAtPeriodEnd      Boolean            @default(false)
  monthlyCredits         Int                @default(50)
  usageCreditsRemaining  Int                @default(50)
  metadata               Json?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  @@index([userId, status])
}

model CreditUsage {
  id           String          @id @default(cuid())
  userId       String
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  generationId String?
  generation   Generation?     @relation(fields: [generationId], references: [id], onDelete: SetNull)
  type         CreditUsageType
  delta        Int
  balanceAfter Int
  description  String?
  metadata     Json?
  createdAt    DateTime        @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([generationId])
}

model AffiliateReferral {
  id                       String          @id @default(cuid())
  referrerId               String
  referrer                 User            @relation("AffiliateReferrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referredUserId           String          @unique
  referredUser             User            @relation("AffiliateReferredUser", fields: [referredUserId], references: [id], onDelete: Cascade)
  code                     String
  status                   AffiliateStatus @default(INVITED)
  commissionRate           Decimal         @default(0.1) @db.Decimal(5, 4)
  lifetimeRevenueCents     Int             @default(0)
  recurringCommissionCents Int             @default(0)
  firstConvertedAt         DateTime?
  payouts                  Payout[]
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt

  @@index([referrerId, createdAt(sort: Desc)])
}

model Payout {
  id               String             @id @default(cuid())
  userId           String
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  referralId       String?
  referral         AffiliateReferral? @relation(fields: [referralId], references: [id], onDelete: SetNull)
  amountCents      Int
  currency         String             @default("USD")
  status           PayoutStatus       @default(PENDING)
  provider         PayoutProvider     @default(STRIPE)
  providerPayoutId String?
  scheduledFor     DateTime?
  paidAt           DateTime?
  metadata         Json?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@index([userId, status])
}

model BrandKit {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String   @default("Default")
  logoUrl        String?
  faviconUrl     String?
  primaryColor   String?
  secondaryColor String?
  accentColor    String?
  fontPrimary    String?
  fontSecondary  String?
  toneOfVoice    String?
  socialLinks    Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

model Review {
  id                 String           @id @default(cuid())
  authorId           String
  author             User             @relation("ReviewAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  sellerId           String?
  seller             User?            @relation("ReviewSeller", fields: [sellerId], references: [id], onDelete: SetNull)
  storeProductId     String?
  storeProduct       StoreProduct?    @relation("ReviewStoreProduct", fields: [storeProductId], references: [id], onDelete: SetNull)
  templateId         String?
  template           Template?        @relation("ReviewTemplate", fields: [templateId], references: [id], onDelete: SetNull)
  orderId            String?          @unique
  order              Order?           @relation(fields: [orderId], references: [id], onDelete: SetNull)
  rating             Int
  title              String?
  comment            String?
  targetType         ReviewTargetType
  isVerifiedPurchase Boolean          @default(false)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([authorId, createdAt(sort: Desc)])
  @@index([sellerId])
  @@index([storeProductId])
  @@index([templateId])
}
